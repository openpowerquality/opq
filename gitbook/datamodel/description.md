# OPQ Data Model

## Overview {#overview}

At the core of the OPQ system lies a centralized MongoDB database. OPQMauka and OPQMakai both primarily act as producers of data, while OPQView is solely a consumer of data.
The following section will provide a high-level overview of OPQ's data model.

## Data Model

The OPQ system utilizes the following collections:
* **Measurements:** Provides low-fidelity OPQBox data
* **Events:** Provides detected events
* **Box_Events:** Provides high-fidelity event data
* **Fs.Files:** Internal to GridFS filesystem (file meta-data)
* **Fs.Chunks:** Internal to GridFS filesystem (file binary data)


### Measurements

The **measurements** collection provides low-fidelity OPQBox snapshot data at a given moment in time.
Due to the high default sampling rate of the corresponding [OPQMauka measurements plugin](../mauka/plugins.md#measurement), documents in this collection are produced at very rapid rate.
As such, each measurement document can essentially be thought of as an OPQBox "heartbeat", providing a timestamp and some additional low-fidelity data.

![Measurements Collection](images/measurements-collection.png)

Each measurement document always corresponds to a single OPQBox, as indicated by the **box_id** field.
The **voltage** and **frequency** fields are RMS calculations of voltage and frequency at a given moment in time, indicated by the **timestamp_ms** field.

### Events and Box Events

#### Events
The **events** collection provides events detected by the OPQ System. These documents are generated by OPQMakai after being requested by OPQMauka upon event detection.

![Events and Box Events Collection](images/events-boxevents-collection.png)

The **event_id** field is a unique integer value generated for each event. 

The **type** field indicates the classification of the event, as determined by OPQMauka. (*Anthony: Do we have a list of all possible event types somewhere?*)

The **description** field indicates additional information about the event (*Serge: Clarify on this?*)

The **boxes_triggered** array is a list of all OPQBoxes associated with the given event - however it is important to note that this does not always correspond to all of the OPQBoxes for which we have received actual data from for the event.

The **latencies** field provides (*Serge: Clarify on this array? Note that this was previously named "timestamps"*)

#### Box Events
The **box_events** collection provides the event meta-data for a given OPQBox.

The **event_id** field corresponds to the event_id generated by the aforementioned **events** document.

The **box_id** field indicates the box for which this document's data represents

As an event can be associated with multiple OPQBoxes, it is therefore important to understand that there can be (and often are) multiple box_event documents with the same event_id.
Together, the **event_id** and **box_id** fields are what one would query on in order to find data for a given OPQBox for a specific event.

The **event_start** and **event_end** fields are unix timestamps indicating the start and event of the event.

The **latencies** array is (*Serge: Again, could you clarify on this? Was previously named timestamps*)

The **thd** and **itic** fields correspond to the total harmonic distortion and ITIC values, as calculated by the OPQMauka [THD](../mauka/plugins.md#thd) and [ITIC](../mauka/plugins.md#itic) plugins.

The **data_fs_filename** field indicates the GridFS filename that holds the box_event's actual raw waveform data.

### GridFS
[GridFS](https://docs.mongodb.com/manual/core/gridfs/) is a MongoDB specification for storing large documents. As an OPQBox can collect a very large amount of data for each given event (often exceeding the 16 MB MongoDB document size limit), we've opted to utilize GridFS to store our high-fidelity data.
At its core, GridFS is a very simple system consisting of two collections, **fs.files** and **fs.chunks**. 

![GridFS Collections](images/gridfs-collections.png)

#### FS.Files
The **fs.files** collection is internal to GridFS and stores file metadata.
All fields except **metadata.event_id** and **metadata.box_id** are generated by GridFS upon document creation.
Of all these fields internal to GridFS, the most noteworthy is the **filename** field, which corresponds to the box_event's **data_fs_filename** field.

The **metadata.event_id** and **metadata.box_id** fields are used to find the corresponding **box_event** document for which this file holds data for.

Note: The GridFS specification requires the **metadata** field be used to store any external information for the given file document. See [GridFS files.metadata](https://docs.mongodb.com/manual/core/gridfs/#files.metadata)  for more information.

#### FS.Chunks
This collection is internal to GridFS and is used for storing file chunks.

